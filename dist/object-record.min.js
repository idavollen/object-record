!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e["object-record"]=t()}(this,function(){"use strict";function e(t,n){if(console.log("incoming = ",t,n),0!==t.length||0!==n.length){if(0===t.length&&n.length)return["+|"+JSON.stringify(n)+"|0"];if(t.length&&0===n.length)return["-|"+JSON.stringify(t)+"|0"];var o=l.apply(void 0,t),i=l.apply(void 0,n),g=[],h={},p={},y={};for(var v in i){var b=-1,m=i[v],x=void 0;for(x in o){var j=o[x];if(s(m)&&s(j)){var O=e(j,m);if(!O){b=x;break}}else if("object"==typeof m&&"object"==typeof j){var J=r(j,m);if(console.log("diffs between js objects:",J,j,m,x,v),!J){b=x;break}}else if(m===j){b=x;break}}b===-1?(u(p,m,+v),console.log("no match:",v,p)):(u(h,m,+v,b),delete o[x],console.log("found match:",x,v,h,o))}console.log("after loop, curObj =",o);for(var N in o)u(y,o[N],+N);console.log("after stagging: curObj = ",o),f(p,"idx","startIdx"),f(h,"idx","startIdx"),f(y,"idx","startIdx"),console.log("b4 normalizing, matches = ",h);for(var S=Object.keys(h).length,k=0;S>k;k++){var I=void 0;for(var A in h)if(void 0!==I){var w=h[A];if(A>I.idx&&I.obj.pidx>w.pidx){if(w.elms.length>I.obj.elms.length){delete h[I.idx],d(y,I.obj.pidx,I.obj.elms),d(p,I.idx,I.obj.elms);break}delete h[A],d(y,w.pidx,w.elms),d(p,A,w.elms)}else I={idx:A,obj:w}}else I={idx:A,obj:h[A]}}if(console.log("staged parts: ",p,y,h),a(y)&&!a(p))for(var C in p)g.push("+|"+JSON.stringify(p[C].elms)+"|"+C);else if(!a(y)&&a(p))for(var E in y)g.push("-|"+JSON.stringify(y[E].elms)+"|"+E);else if(!a(y)&&!a(p)){var _=Object.keys(h).length;if(console.log("being here, matched = ",_),!_||_>3&&_>Math.min(t.length,n.length)/2)console.log("there exists too many matched",_),g.push("c|"+JSON.stringify(t)+"|"+JSON.stringify(n)+"|0");else{var z=0;for(var D in h){var M=void 0,T=void 0;for(var q in p){D>q&&(M={idx:q,val:p[q].elms},z+=p[q].elms.length,delete p[q]);break}for(var B in y){h[D].pidx>B&&(T={idx:B,val:y[B].elms},delete y[B]);break}console.log("matched idx:",D,h[D],M,T,g),M&&T?g.push("c|"+JSON.stringify(T.val)+"|"+JSON.stringify(M.val)+"|"+M.idx):M?g.push("+|"+JSON.stringify(M.val)+"|"+M.idx):T&&g.push("-|"+JSON.stringify(T.val)+"|"+z),console.log("new diffs in loop:",g),z+=h[D].elms.length}console.log("after loop, situations:",y,p,g),a(y)||a(p)?a(p)?a(y)||g.push("-|"+JSON.stringify(c(y,0).elms)+"|"+z):g.push("+|"+JSON.stringify(c(p,0).elms)+"|"+Object.keys(p)[0]):g.push("c|"+JSON.stringify(c(y,0).elms)+"|"+JSON.stringify(c(p,0).elms)+"|"+Object.keys(p)[0]),console.log("final diffs:",g)}}return g.length?g:void 0}}function t(r,n){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],l=Object.keys(r),c=Object.keys(n);if(0===l.length&&0===c.length)return i;for(var a=c.length-1;a>=0;a--)if(0!==l.length){for(var f=l.length>0?l.length-1:0;l.length>0&&f>=0;f--)if(c[a]===l[f]){if(s(n[c[a]])&&s(r[l[f]])){var g=e(r[l[f]],n[c[a]]);g&&i.push((o?o+":"+a:a)+"/a/"+JSON.stringify(g))}else"object"==typeof n[c[a]]&&"object"==typeof r[l[f]]?t(r[l[f]],n[c[a]],o?o+":"+a:a,i):n[c[a]]!==r[l[f]]&&i.push((o?o+":"+a:a)+"/c/"+JSON.stringify(r[l[f]])+"/"+JSON.stringify(n[c[a]]));l.splice(f,1);break}0>f&&l.length>0&&i.push((o?o+":"+a:a)+"/+/"+c[a]+"/"+JSON.stringify(n[c[a]]))}else i.push((o?o+":"+a:a)+"/+/"+c[a]+"/"+JSON.stringify(n[c[a]]));for(var d=0;l.length>d;d++)i.push((o?o+":"+(c.length+d):c.length+d)+"/-/"+l[d]+"/"+JSON.stringify(r[l[d]]));return i}function r(e,r){if("object"==typeof e&&"object"==typeof r){var n=t(e,r);if(void 0!=n&&0!==n.length)return n}}function n(e,t,r){console.log("_deduceArray incoming cur = ",e,t,r);var n=[],o=0,i=0;return t.forEach(function(t){var l=t.split("|");if(console.log("_deduceArray:",o,i,l,"newAry = ",n),"c"===l[0]){var s=+l[3],c=r?o+s-i:s,a=g(e,o,c,n);o+=a,i+=a,console.log("b4 deduced by change op",e[l[3]]);var f=JSON.parse(r?l[2]:l[1]);n.splice.apply(n,[i,0].concat(f)),i+=f.length;var d=JSON.parse(r?l[1]:l[2]);o+=d.length,console.log("deduced by change op change",n,d,i,o)}else if("+"===l[0]){var u=+l[2],h=r?o+u-i:u,p=g(e,o,h,n);o+=p,i+=p;var y=JSON.parse(l[1]);r?(n.splice.apply(n,[i,0].concat(y)),i+=y.length):o+=y.length,console.log("deduced by change op+",n,y,i,o)}else if("-"===l[0]){var v=+l[2],b=o,m=r?b+v-i:v;console.log("b4 aryCopy:",b,m,v,o,i);var x=g(e,b,m,n);o+=x,i+=x;var j=JSON.parse(l[1]);r?o+=j.length:(n.splice.apply(n,[i,0].concat(j)),i+=j.length),console.log("deduced by change op-",n,j,i,o)}}),e.length>o&&(console.log("remaining elms",n,o,i),n.splice.apply(n,[i,0].concat(e.slice(o)))),console.log("orig = ",n),n}function o(e,t,r){var o=Object.assign({},e);return t.forEach(function(e){var t=e.split("/"),i=t[0].split(":"),l=i.pop(),s=i.reduce(function(e,t){return e[Object.keys(e)[t]]},o),c=1===r||"f"===r;"a"===t[1]?(console.log("cur val at node(Array) = ",s[Object.keys(s)[l]],s,l,t),s[Object.keys(s)[l]]=n(s[Object.keys(s)[l]],JSON.parse(t[2]),c),console.log("after val at node = ",s[Object.keys(s)[l]],s,l,o)):"c"===t[1]?s[Object.keys(s)[l]]=JSON.parse(c?t[3]:t[2]):"+"===t[1]?c?s[[t[2]]]=JSON.parse(t[3]):delete s[t[2]]:"-"===t[1]&&(c?delete s[t[2]]:s[[t[2]]]=JSON.parse(t[3]))}),o}function i(){function e(e,t,r){l.history.count>i.histories.length||i.histories.splice(0,1),i.histories.push({diffs:t,cause:r,ts:(new Date).getTime()}),i.cur.obj=e,i.cur.index=i.histories.length-1}function t(){return{cur:Object.assign({},i.cur),forward:i.histories.length-i.cur.index-1,back:i.histories.length>0?i.cur.index+1:0}}var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:h,i={cur:{obj:n.obj||{},index:-1},histories:[]},l=n;return{current:function(){return t()},update:function(n,o){var l=r(i.cur.obj,n);return l&&l.length>0&&e(n,l,o),t()},forward:function(){return i.histories.length-1>i.cur.index&&(i.cur.index++,i.cur.obj=o(i.cur.obj,i.histories[i.cur.index].diffs,"f")),t()},back:function(){if(i.cur.index>=0){var e=o(i.cur.obj,i.histories[i.cur.index].diffs,"b");i.cur.obj=e,i.cur.index--}return t()},go:function(e){if(e>0)for(;e-- >0;)this.forward();else if(0>e)for(;e++<0;)this.back();return t()}}}var l=function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return t.reduce(function(e,t,r){return e[r]=t,e},{})},s=function(e){return Array.isArray&&Array.isArray(e)||e&&e.constructor===Array},c=function(e,t){return e&&e[Object.keys(e)[t]]},a=function(e){return!(e&&(e.length||Object.keys(e).length))},f=function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;t>n;n++)r[n-1]=arguments[n];return r.reduce(function(e,t){return delete e[t],e},e)},g=function(e,t,r,n){if(console.log("aryCopy:",e,t,r,n),t>=0&&r>t&&e.length>=r){var o=e.slice(t,r);return n.push.apply(n,o),console.log("after aryCopy:",n,o),r-t}return 0},d=function(e,t,r){var n=Object.keys(e),o=!1;t=+t,console.log("updating obj:",e,t,"array:",r,"keys = ",n);for(var i=0;n.length>i;i++){var l=n[i],s=+l;if(e[l])if(t>s&&e[l].elms.length+s===t){var c;console.log("found lower match",s,e[l].elms);var a=(c=e[l].elms).concat.apply(c,r);if(o=!0,n.length-1>i&&t+r.length===+n[i+1]){var f;console.log("merging follwing matched");var g=e[n[i+1]];a=(f=a).concat.apply(f,g.elms),delete e[n[i+1]]}console.log("newly merged melms",a),e[l].elms=a}else if(s>t&&t+r.length==s){console.log("found upper match",s,e[l].elms);var d=r.concat.apply(r,e[l].elms);if(o=!0,i>0){var u=e[n[i-1]];if(+n[i-1]+u.elms.length===t){var h;e[n[i-1]].elms=(h=u.elms).concat.apply(h,d),delete e[l];continue}}e[t]={elms:r.concat.apply(r,e[l].elms)},delete e[l]}}o||(e[t]={elms:r}),console.log("after updating obj = ",e)},u=function(e,t,r,n){return n=void 0!=n&&+n||n,void 0===e.startIdx&&(e.startIdx=r,e[e.startIdx]={elms:[]},void 0!==n&&(e[e.startIdx].pidx=n)),void 0===e.idx||r===e.idx+1&&(void 0===n||void 0!==n&&void 0!==e[e.startIdx].pidx&&n==e[e.startIdx].elms.length+ +e[e.startIdx].pidx)?e[e.startIdx].elms.push(t):(e.startIdx=r,e[e.startIdx]={elms:[t]},void 0!==n&&(e[e.startIdx].pidx=n)),e.idx=r,e},h={obj:{},history:{count:50}};return i});
